---
title: "fish_base"
author: "Leonardo Feitosa"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rfishbase)
library(here)
library(janitor)
library(vroom)
```

```{r}
test_fishbase <- load_taxa() %>%
  filter(Class == "Elasmobranchii") %>%
  select(Species, Family, Order) %>%
  rename(
    scientific_name = Species,
    family = Family,
    order = Order
  )
```

```{r}
test_fishbase <- test_fishbase %>%
  mutate(group = case_when(
    str_detect(family, "Mobulidae|Dasyatidae|Gymnyridae|Myliobatidae|Torpedinidae|Rhinobatidae|Rhinidae|Aetobatidae|Rajidae|Pristidae|Plesiobatidae|Potamo|Urolophidae|Zanobatidae|Narcinidae|Platyrhinidae|Trygon|Hypnidae|Narkidae") ~ "Batoids",
    str_detect(
      scientific_name,
      "Himantura|Dasyatis|Gymnura|trygon|Bathytoshia|rays|raja|Rhinoptera|Sympterygia|Pastinachus|Urobatis|Glaucostegus|Hypanus"
    ) ~ "Batoids",
    TRUE ~ "Sharks"
  ))
```

```{r}
# count species of sharks and rays present in fishbase
fishbase_sharks <- test_fishbase %>%
  filter(group == "Sharks") %>%
  count() %>%
  mutate(pct = 100 * (94 / n))

fishbase_batoids <- test_fishbase %>%
  filter(group == "Batoids") %>%
  count() %>%
  mutate(pct = 100 * (35 / n))

fishbase_rhino <- test_fishbase %>%
  filter(order == "Rhinopristiformes") %>%
  count() %>%
  mutate(pct = 100 * (4 / n))
```

```{r}
# get shark and ray scientific names
shark_spp <- fb_tbl("species") %>%
  clean_names() %>%
  filter(str_detect(genus, "Carcharhinus|Glyphis|Isogomphodon|Lamiopsis|Loxodon|Rhizoprionodon|Scoliodon|Triaenodon|Galeocerdo|Chaenogaleus|Hemigaleus|Hemipristis|Paragaleus|Leptocharias|Ctenacis|Eridacnis|Gollum|Proscyllium|Pseudotriakis|Apristurus|Asymbolus|Bythaelurus|Cephalurus|Figaro|Galeus|Halaelurus|Haploblepharus|Holohalaelurus|Parmaturus|Pentanchus|Atelomycterus|Aulohalaelurus|Cephaloscyllium|Poroderma|Schroederichthys|Scyliorhinus|Sphyrna|Furgaleus|Galeorhinus|Hemitriakis|Hypogaleus|Iago|Mustelus|Triakis|Scylliogaleus|Heterodontus|Hexanchus|Notorynchus|Chlamydoselachus|Carcharias|Carcharias|Carcharodon|Isurus|Lamna|Alopias|Cetorhinus|Megachasma|Mitsukurina|Odontaspis|Brachaelurus|inglymostoma|Nebrius|Chiloscyllium|Hemiscyllium|Orectolobus|Eucrossorhinus|Sutorectus|Cirrhoscyllium|Parascyllium|Rhincodon|Stegostoma|Pristiophorus|Pliotrema|Squatina|Squalus|Etmopterus|Centrophorus|Daenia|Dalatias|Euprotomicroides|Heteroscymnoides|Isistius|Mollisquama|Squaliolus|Echinorhinus|Aculeola|Centroscyllium|Centroscymnus|Scymnodalatias|Scymnodon|Somniosus|Cirrhigaleus|Oxynotus|Aetobatus|Bathytoshia|trygon|Dasyatis|Himantura|Hypanus|Maculabatis|Pastinachus|Pateobatis|Taeniura|Urogymnus|Gymnura|Aetomylaeus|Myliobatis|Manta|Mobula|Plesiobatis|Rhinoptera|Spinilophus|Urolophus|Urobatis|raja|batis|Springeria|Irolita|Sympterygia|Gurgesiella|Dipturus|Hongeo|Okamejei|Raja|Rajella|Glaucostegus|Platyrhin|Pristis|Anoxypristis|Acroteriobatus|Pseudobatos|Rhinobatos|Rhina|Rhynchobatus|Aptychotrema|Trygonorrhina|Zapteryx|Zanobatus|Hypnos|Benthobatis|Diplobatis|Discopyge|Narcine|Crassinarke|Electrolux|Heteronarce|Narke|Temera|Typhlonarke|Tetronarce|Torpedo")) %>%
  filter(!str_detect(genus, "Potamotrygon|Paratrygon|Heliotrygon|Plesiotrygon|Glyphis")) %>% # remove freshwater stingrays and sharks
  select(genus, species, demers_pelag, length, l_type_max_m, depth_range_shallow, depth_range_deep, demers_pelag) %>%
  unite(scientific_name, c("genus", "species"), sep = " ", remove = FALSE)

write_csv(shark_spp, file = file.path(basedir, "data", "shark_spp_list.csv"), col_names = TRUE)
```

```{r}
# call PRM dataset
prm_elasmo <- read_csv(here("data", "prm_dataset_updated.csv"))

prm_elasmo <- prm_elasmo %>%
  rename(scientific_name = species)

prm_elasmo_join <- prm_elasmo %>%
  left_join(shark_spp, by = "scientific_name") %>%
  select(-c(genus, species, length, l_type_max_m, depth_range_shallow, depth_range_deep, stock_code, spec_code, species_ref_no, fam_code, habitat_associated)) %>%
  rename(habitat_associated = demers_pelag) %>%
  relocate(habitat_associated, .after = median_temp) %>%
  mutate(habitat_associated = case_when(
    habitat_associated == "pelagic-oceanic" ~ "pelagic",
    scientific_name == "Prionace glauca" ~ "pelagic",
    str_detect(scientific_name, "canis") ~ "demersal",
    str_detect(scientific_name, "Centrophorus") ~ "bathydemersal",
    str_detect(scientific_name, "perlo") ~ "bathydemersal",
    str_detect(scientific_name, "Deania") ~ "bathydemersal",
    str_detect(scientific_name, "Himantura") ~ "demersal",
    str_detect(scientific_name, "Negaprion") ~ "reef-associated",
    str_detect(scientific_name, "limbatus") ~ "reef-associated",
    str_detect(scientific_name, "Leucoraja") ~ "demersal",
    str_detect(scientific_name, "Rhizo") ~ "demersal",
    str_detect(scientific_name, "antarticus") ~ "demersal",
    str_detect(scientific_name, "Pseudo") ~ "pelagic",
    str_detect(scientific_name, "Centroscymnus owstoni") ~ "bathydemersal",
    str_detect(scientific_name, "Trygonoptera testacea") ~ "demersal",
    TRUE ~ habitat_associated
  )) %>%
  mutate(scientific_name = case_when(
    str_detect(scientific_name, "antarticus") ~ "Mustelus antarcticus",
    str_detect(scientific_name, "Rhizoprionodon terranovae") ~ "Rhizoprionodon terraenovae",
    str_detect(scientific_name, "Squalus sp.") ~ "Squalus sp",
    str_detect(scientific_name, "Orectolobus spp.") ~ "Orectolobus sp",
    TRUE ~ scientific_name
  ))

write_csv(prm_elasmo_join, file = here("data", "prm_dataset_updated.csv"), col_names = TRUE, na = "")

# Call saup species list from Worm et al (XXXX)
saup_spp2 <- read_csv(here("data", "sau_spp_taxonomy_ref_full.csv"))

saup_spp <- read_csv(here("data", "sau_spp_taxonomy_ref.csv"))

# create full dataset of species present in saup
# saup_full <- saup_spp2 %>%
#   left_join(saup_spp, by = "scientific_name") %>%
#   mutate(family = str_to_sentence(family_name),
#          order = str_to_sentence(order_name)) %>%
#   select(-c(genus_name, family_name, order_name)) %>%
#   relocate(family, .after = common_name) %>%
#   relocate(order, .before = ventilation_method)

# write_csv(saup_full, file = here("data", "sau_spp_taxonomy_ref_full.csv"), col_names = TRUE, na = "")

# call the weight to count conversion data by species
weight_conv <- read_csv(here("data", "spp_weight_count_conversion.csv"))

# call the intrinsic population growth rate from Bradley et al (XXXX)
r_data <- read_csv(here("data", "r_estimate_fish.csv")) %>%
  rename(scientific_name = SciName) %>%
  pivot_longer(
    cols = r_fin,
    names_to = "pop_growth_rate_measure",
    values_to = "value"
  )

# call in the intrinsic growth rate data and wrangle it to convert lambda to r
int_growth <- read_csv(here("data", "intrinsic_pop_growth_rates.csv"))

# write_csv(int_growth, file = here("data", "intrinsic_pop_growth_rates.csv"), col_names = TRUE, na = "")

# iucn data
iucn_taxonomy <- read_csv(here("data", "iucn_data", "taxonomy.csv")) %>%
  clean_names() %>%
  select(scientific_name, family_name) %>%
  rename(family = family_name) %>%
  mutate(family = str_to_sentence(family))

iucn_assessment <- read_csv(here("data", "iucn_data", "assessments.csv")) %>%
  clean_names() %>%
  filter(str_detect(systems, "Marine") & str_detect(threats, "longline") | str_detect(scientific_name, "Squatina|Isogomphodon|Carcharhinus|Eusphyra|Orectolobus|Pristiophorus|Mustelus")) %>%
  select(scientific_name, threats, systems, redlist_category)

iucn_data <- iucn_assessment %>%
  left_join(iucn_taxonomy, by = "scientific_name")

# r_data_merge <- shark_spp %>%
#    left_join(r_data, by = "scientific_name")

r_data_full <- bind_rows(r_data_merge, int_growth) %>%
  drop_na(pop_growth_rate_measure) %>%
  select(scientific_name, pop_growth_rate_measure, value, areas, reference, observations) %>%
  mutate(r_value = case_when(
    pop_growth_rate_measure == "lambda" ~ log(value),
    TRUE ~ value
  )) %>%
  group_by(scientific_name) %>%
  mutate(mean_r = mean(r_value)) %>% # calculates mean r values per species because some species have different r values depending on method/sampling area
  relocate(areas, .after = scientific_name) %>%
  relocate(reference, .after = mean_r) %>%
  relocate(observations, .after = reference) %>%
  distinct()


# write_csv(r_data_full, file = here("data", "intrinsic_pop_growth_rates_full.csv"), col_names = TRUE, na = "")
```

```{r}
# join iucn and the sau_spp_taxonomy_ref_full datasets
iucn_saup_join <- iucn_data %>%
  left_join(test_fishbase, by = c("scientific_name", "family")) %>%
  left_join(saup_spp2, by = c("scientific_name", "family", "order")) %>%
  left_join(shark_spp, by = c("scientific_name")) %>%
  mutate(median_depth_2 = rowMeans(select(., depth_range_shallow, depth_range_deep))) %>%
  select(-c(genus, species, depth_range_shallow, depth_range_deep)) %>%
  mutate(measure_fb = case_when(
    l_type_max_m == "TL" ~ "total_length",
    l_type_max_m == "WD" ~ "disk_width"
  )) %>%
  relocate(common_name, .before = family)

write_csv(iucn_saup_join, file = here("data", "iucn_fishbase_list.csv"), col_names = TRUE, na = "")
```

```{r}
# join shark_spp data from fishbase with the saup species list, the species specific weight to count conversion coefficients, and intrinsic population growth rates
shark_saup_join <- iucn_data %>%
  bind_rows(int_growth) %>%
  left_join(test_fishbase, by = c("scientific_name", "family")) %>%
  left_join(weight_conv, by = "scientific_name") %>%
  select(-c(habitat, value, r_value, reference, observations, areas, pop_growth_rate_measure))
mutate(family = case_when(
  str_detect(scientific_name, "dae") ~ scientific_name,
  str_detect(scientific_name, "Sphyrna") ~ "Sphyrnidae",
  str_detect(scientific_name, "Alopias") ~ "Alopidae",
  str_detect(scientific_name, "Scyliorhinus") ~ "Scyliorhinidae",
  str_detect(scientific_name, "Squalus") ~ "Squalidae",
  str_detect(scientific_name, "Etmopterus") ~ "Etmopteridae",
  str_detect(scientific_name, "Mustelus") ~ "Triakidae",
  TRUE ~ family
)) %>%
  distinct() %>%
  arrange(scientific_name) %>%
  drop_na(mean_r)

write_csv(shark_saup_join, file = here("data", "shark_saup_fishbase_spp_list.csv"), col_names = TRUE)
```

```{r}
# Join temp_join with prm_elasmo datasets
prm_join <- prm_elasmo %>%
  left_join(temp_join, by = "scientific_name") %>%
  select(-c(median_temp)) %>%
  rename(median_temp = temp_preferred) %>%
  relocate(median_temp, .after = reproductive_mode)


sheet_write(prm_join, sheet = "prm_dataset_temp_hab")

write_csv(prm_join, file = file.path(basedir, "data", "prm_dataset_temp_hab.csv"), col_names = TRUE)
```

### Check hypoxia data

```{r}
prm_elasmo <- read_csv(here("data", "prm_elasmo_subset.csv")) %>%
  filter(gear_class == "longline") %>%
  filter(!grepl("Rajidae", family)) %>%
  filter(family != "Dasyatidae") %>%
  filter(family != "Pristidae") %>%
  filter(family != "Rhinidae") %>%
  filter(family != "Rhinobatidae") %>% 
  mutate(scientific_name = ifelse(scientific_name == "Mustelus canis insularis", "Mustelus canis", scientific_name))

new_dat <- read_csv(here::here("data", "predict_data.csv")) %>%
  filter(order != "Rajiformes") %>%
  filter(order != "Myliobatiformes") %>%
  filter(order != "Torpediniformes") %>%
  # filter(!grepl("batidae", family)) %>%
  filter(family != "Dasyatidae") %>%
  filter(family != "Dasyatidae") %>%
  # filter(family != "Glaucostegidae") %>% # I'd remove this filter
  # filter(family != "Pristidae") %>% # I'd remove this filter
  filter(family != "Trygonorrhinidae") %>%
  filter(!is.na(median_depth)) %>%
  filter(!is.na(ventilation_method)) %>%
  filter(!is.na(reproductive_mode)) %>%
  filter(!is.na(habitat_associated)) %>%
  filter(!is.na(max_size_cm)) %>%
  mutate(ventilation_method = as.factor(ventilation_method)) %>%
  mutate(habitat_associated = as.factor(habitat_associated)) %>%
  mutate(reproductive_mode = as.factor(reproductive_mode)) %>%
  filter(reproductive_mode != "histotrophy")

tol = read_csv(here("data", "tolerance.csv")) %>% 
  rename(scientific_name = species) %>% 
  mutate(scientific_name = ifelse(scientific_name == "Stegostoma fasciatum", "Stegostoma tigrinum", scientific_name))
# eo is thermal sensitivity
# ac is active hypoxia vulnerability
```

```{r}
dat = full_join(prm_elasmo, new_dat) %>%
  left_join(tol) %>% 
  mutate(species = scientific_name) %>% 
  separate_wider_delim(species, names = c("genus", "species"), delim = " ") 
```

```{r}
# populate NAs in eo and ac with family averages
dat_new_mean <- dat %>%
  group_by(genus) %>% 
  mutate(eo_new_gen = ifelse(is.na(eo), mean(eo, na.rm = TRUE), eo),
         ac_new_gen = ifelse(is.na(ac), mean(ac, na.rm = TRUE), ac)) %>% 
  group_by(family) %>% 
  mutate(eo_new_fam = ifelse(is.na(eo), mean(eo, na.rm = TRUE), eo),
         ac_new_fam = ifelse(is.na(ac), mean(ac, na.rm = TRUE), ac)) %>% 
  ungroup() %>% 
  mutate(eo = ifelse(is.na(eo), eo_new_gen, eo),
         eo = ifelse(is.nan(eo_new_gen), eo_new_fam, eo),
         ac = ifelse(is.na(ac), ac_new_gen, ac),
         ac = ifelse(is.nan(ac_new_gen), ac_new_fam, ac))

dat_predict = dat_new_mean %>% 
  filter(scientific_name %in% prm_elasmo$scientific_name) %>% 
  distinct() %>% 
  filter(!is.na(estimate))

write_csv(dat_predict, here::here("data", "prm_hypoxia.csv"))

dat_new_mean = dat_new_mean %>% 
  filter(scientific_name %in% new_dat$scientific_name) %>% 
  filter(is.na(estimate))

write_csv(dat_new_mean, here::here("data", "predict_data_hyp.csv"), col_names = TRUE, na = "")
```