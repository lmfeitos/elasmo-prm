---
title: "data_summary"
author: "Leonardo Feitosa"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE)
library(tidyverse)
library(here)
library(ggh4x)

# Set data paths
basedir <- "G:/Meu Drive/PRM review/"
datadir <- file.path(basedir, "data/fish_base_data")
outdir <- file.path(basedir, "data/outputs") # calls present data from raster files
```

```{r}
# read in the data
prm_elasmo <- read_csv(here("data", "prm_dataset.csv")) %>% 
  rename(scientific_name = species)
```

```{r}
# calculating mean values for those taxa at higher levels than species
## Dasyatis sp
dasyatis_sp <- prm_elasmo %>% 
  filter(str_detect(family, "Dasyatidae")) %>% 
  mutate(mean_size = mean(max_size_cm, na.rm = TRUE),
         mean_depth = mean(median_depth, na.rm = TRUE))

## Squalus sp
squalus_sp <- prm_elasmo %>% 
  filter(str_detect(scientific_name, "Squalus")) %>% 
  mutate(mean_size = mean(max_size_cm, na.rm = TRUE),
         mean_depth = mean(median_depth, na.rm = TRUE))

## Mustelus sp
mustelus_sp <- prm_elasmo %>% 
  filter(str_detect(scientific_name, "Mustelus")) %>% 
  mutate(mean_size = mean(max_size_cm, na.rm = TRUE),
         mean_depth = mean(median_depth, na.rm = TRUE))

## Centrophorus sp
centrophorus_sp <- prm_elasmo %>% 
  filter(str_detect(scientific_name, "Centrophorus")) %>% 
  mutate(mean_size = mean(max_size_cm, na.rm = TRUE),
         mean_depth = mean(median_depth, na.rm = TRUE))

## sharks
sharks <- prm_elasmo %>% 
  filter(str_detect(common_name, "shark")) %>% 
  mutate(mean_size = mean(max_size_cm, na.rm = TRUE),
         mean_depth = mean(median_depth, na.rm = TRUE))

## rays
rays <- prm_elasmo %>% 
  filter(str_detect(measure, "disk_width")) %>% 
  mutate(mean_size = mean(max_size_cm, na.rm = TRUE),
         mean_depth = mean(median_depth, na.rm = TRUE))
```


```{r}
# data wrangling
prm_elasmo_subset <- prm_elasmo %>% 
  select(scientific_name, gear_class, habitat_associated, estimate_type, estimate, sample_size,
         method, ventilation_method, max_size_cm, measure, median_depth, reproductive_mode, family) %>% 
  mutate(max_size_cm = case_when( # filling missing information based on the average per group
    scientific_name == "Dasyatis sp" ~ 146.22,
    scientific_name == "Squalus sp" ~ 141.12,
    scientific_name == "Mustelus sp" ~ 171.9,
    scientific_name == "Centrophorus sp" ~ 165.75,  
    scientific_name == "sharks" ~ 347.2639,
    scientific_name == "rays" ~ 170.2222, # only calculated for the batoid species with disk width measures
    TRUE ~ max_size_cm
  )) %>% 
  mutate(median_depth = case_when( # filling missing information based on the average per group
    scientific_name == "Dasyatis sp" ~ 139.33,
    scientific_name == "Squalus sp" ~ 601.875,
    scientific_name == "Mustelus sp" ~ 254.3929,
    scientific_name == "Centrophorus sp" ~ 1136.25,
    scientific_name == "sharks" ~ 313.2104,
    scientific_name == "rays" ~ 120.5278,
    TRUE ~ median_depth
  )) %>% 
  mutate(measure = case_when(
    scientific_name == "sharks" ~ "total_length",
    scientific_name %in% c("rays", "Dasyatis sp") ~ "disk_width",
    TRUE ~ measure
  )) %>% 
  mutate(reproductive_mode = case_when(
    scientific_name == "sharks" ~ "yolk-sac viviparity",
    scientific_name == "rays" ~ "yolk-sac viviparity",
    TRUE ~ reproductive_mode
  )) %>%
  mutate_if(is.character, as.factor)

# Create subset of the whole dataset with at-vessel mortality and calculate the weighted averages per species
mort_summary <- prm_elasmo_subset %>% 
  filter(estimate_type %in% c("at-vessel mortality", "post-release mortality") & estimate > 0) %>% 
  mutate(est_count = sample_size * estimate) %>% 
  group_by(scientific_name, estimate_type) %>% 
  mutate(mortality_prop = sum(est_count) / sum(sample_size)) %>% 
  ungroup() %>% 
  group_by(scientific_name, estimate_type) %>% 
  summarise(mean_mort = mean(mortality_prop)) %>% 
  drop_na()  

elasmo_avm <- prm_elasmo_subset %>%
  filter(estimate_type == "at-vessel mortality" & estimate > 0) %>% 
  mutate(est_count = sample_size * estimate) %>% 
  group_by(scientific_name) %>% 
  mutate(mortality_prop = sum(est_count) / sum(sample_size)) %>% 
  drop_na() %>% 
  filter(!gear_class %in% c("handline", "purse seine"))

# Create subset of the whole dataset with post-release mortality and calculate the weighted averages per species
elasmo_prm <- prm_elasmo_subset %>% 
  filter(estimate_type == "post-release mortality" & estimate > 0) %>% 
  mutate(est_count = sample_size * estimate) %>% 
  group_by(scientific_name) %>% 
  mutate(mortality_prop = sum(est_count) / sum(sample_size)) %>% 
  drop_na() %>% 
  filter(!gear_class %in% c("handline", "purse seine", "pole and line"))
```


```{r, fig.height=12, fig.width=8, message = TRUE}
# visualization of AVM and PRM proportions per species and family
ggplot() +
  geom_point(data = mort_summary %>% 
#               filter(estimate_type == "at-vessel mortality") %>% 
               mutate(estimate_type = str_to_title(estimate_type)), 
             aes(x = fct_reorder(scientific_name, mean_mort), 
                 y = mean_mort, 
                 color = estimate_type),
             size = 1.6,
             show.legend = FALSE) +
  facet_wrap(~ estimate_type) +
  labs(x = "",
       y = "Mortality proportion",
       color = "") +
  scale_y_continuous(expand = c(0.01,0.01)) +
  coord_flip() +
  theme_bw() +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 11, color = "black"),
        legend.position = "bottom",
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        strip.background = element_rect(fill = "transparent"),
        panel.spacing = unit(5, "mm"))
```


```{r}
# Create subset of the whole dataset with at-vessel mortality and calculate the weighted averages per family 
mort_summary_fam <- prm_elasmo_subset %>%
  filter(estimate_type %in% c("at-vessel mortality", "post-release mortality") & estimate > 0) %>% 
  mutate(est_count = sample_size * estimate) %>% 
  group_by(family, estimate_type) %>% 
  mutate(mortality_prop = sum(est_count) / sum(sample_size)) %>% 
  ungroup() %>% 
  group_by(family, estimate_type) %>% 
  summarise(mean_mort = mean(mortality_prop)) %>% 
  drop_na()  

mort_summary_fam_seg <-mort_summary_fam %>% 
  pivot_wider(names_from = estimate_type,
              values_from = mean_mort)

# Create subset of the whole dataset with at-vessel mortality and calculate the weighted averages per species 
elasmo_avm_fam <- elasmo_avm %>%
  group_by(family) %>% 
  summarise(mean_prop = mean(mortality_prop))
  
# Create subset of the whole dataset with post-release mortality and calculate the weighted averages per species 
elasmo_prm_fam <- elasmo_prm %>% 
  group_by(family) %>% 
  summarise(mean_prop = mean(mortality_prop))
```


```{r, fig.height=8, fig.width=8, message = TRUE}
ggplot() +
  geom_point(data = mort_summary_fam %>% 
               mutate(estimate_type = str_to_title(estimate_type)),
             aes(x = fct_reorder(family, mean_mort), 
                 y = mean_mort, 
                 color = estimate_type),
             size = 1.6,
             show.legend = FALSE) +
  facet_wrap(~ estimate_type) +
  labs(x = "",
       y = "Mortality proportion",
       color = "") +
  scale_y_continuous(expand = c(0.01,0.01)) +
  coord_flip() +
  theme_bw() +
  theme(axis.text = element_text(size = 10, color = "black"),
        axis.title = element_text(size = 11, color = "black"),
        legend.position = "bottom",
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        strip.background = element_rect(fill = "transparent"),
        panel.spacing = unit(5, "mm"))
```


```{r}
# # Create subset of the whole dataset with at-vessel mortality and calculate the weighted averages per species and gear
mort_summary_gear <- prm_elasmo_subset %>% 
  filter(estimate_type %in% c("at-vessel mortality", "post-release mortality") & estimate > 0) %>% 
  filter(!gear_class %in% c("handline", "purse seine", "pole and line")) %>% 
  mutate(est_count = sample_size * estimate) %>% 
  group_by(scientific_name, gear_class, estimate_type) %>% 
  mutate(mortality_prop = sum(est_count) / sum(sample_size)) %>% 
  ungroup() %>% 
  group_by(scientific_name, gear_class, estimate_type) %>% 
  summarise(mean_mort = mean(mortality_prop)) %>% 
  drop_na()  
```


```{r, fig.height=20, fig.width=10}
ggplot() +
  geom_point(data = mort_summary_gear %>% 
               mutate(estimate_type = str_to_title(estimate_type),
                      gear_class = str_to_title(gear_class)), 
             aes(x = fct_reorder(scientific_name, mean_mort), 
                 y = mean_mort, 
                 color = estimate_type),
             size = 1.6,
             show.legend = FALSE) +
  facet_grid2(gear_class ~ estimate_type,
             scales = "free_y",
             independent = "y") +
  labs(x = "",
       y = "Mortality proportion",
       color = "") +
  scale_y_continuous(expand = c(0.01,0.01)) +
  coord_flip() +
  theme_bw() +
  theme(axis.text = element_text(size = 8, color = "black"),
        axis.title = element_text(size = 11, color = "black"),
        legend.position = "bottom",
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        strip.background = element_rect(fill = "transparent"),
        panel.spacing = unit(5, "mm"))
```

```{r}
# # Create subset of the whole dataset with at-vessel mortality and calculate the weighted averages per species and gear
mort_fam_summary_gear <- prm_elasmo_subset %>% 
  filter(estimate_type %in% c("at-vessel mortality", "post-release mortality") & estimate > 0) %>% 
  filter(!gear_class %in% c("handline", "purse seine", "pole and line")) %>% 
  mutate(est_count = sample_size * estimate) %>% 
  group_by(family, gear_class, estimate_type) %>% 
  mutate(mortality_prop = sum(est_count) / sum(sample_size)) %>% 
  ungroup() %>% 
  group_by(family, gear_class, estimate_type) %>% 
  summarise(mean_mort = mean(mortality_prop)) %>% 
  drop_na()  
```


```{r, fig.height=20, fig.width=10}
ggplot() +
  geom_point(data = mort_fam_summary_gear %>% 
               mutate(estimate_type = str_to_title(estimate_type),
                      gear_class = str_to_title(gear_class)), 
             aes(x = fct_reorder(family, mean_mort), 
                 y = mean_mort, 
                 color = estimate_type),
             size = 1.6,
             show.legend = FALSE) +
  facet_grid2(gear_class ~ estimate_type,
             scales = "free_y",
             independent = "y") +
  labs(x = "",
       y = "Mortality proportion",
       color = "") +
  scale_y_continuous(expand = c(0.01,0.01)) +
  coord_flip() +
  theme_bw() +
  theme(axis.text = element_text(size = 8, color = "black"),
        axis.title = element_text(size = 11, color = "black"),
        legend.position = "bottom",
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        strip.background = element_rect(fill = "transparent"),
        panel.spacing = unit(5, "mm"))
```


```{r}
ggplot(data = prm_elasmo %>% 
         filter(estimate_type != "post-release survival")) +
  geom_point(aes(x = max_size_cm, estimate)) +
  facet_wrap(~ estimate_type) +
  labs(x = "Maximum size (cm)",
       y = "Proportion of mortality") +
  theme_bw()
```

```{r}
ggplot(data = prm_elasmo %>% 
         filter(estimate_type != "post-release survival")) +
  geom_point(aes(x = median_depth, estimate)) +
  facet_wrap(~ estimate_type) +
  labs(x = "Median depth of occurrence (m)",
       y = "Proportion of mortality") +
  theme_bw()
```

```{r, fig.width=8, fig.height=8}
ggplot(data = prm_elasmo %>% 
         filter(estimate_type != "post-release survival")) +
  geom_boxplot(aes(x = family, y = estimate)) +
  facet_wrap(~ estimate_type) +
  labs(x = "",
       y = "Proportion of mortality") +
  coord_flip() +
  theme_bw()
```


```{r}
ggplot(data = prm_elasmo %>% 
         filter(estimate_type != "post-release survival")) +
  geom_boxplot(aes(x = gear_class, y = estimate)) +
  facet_wrap(~ estimate_type) +
  labs(x = "Gear class",
       y = "Proportion of mortality") +
  coord_flip() +
  theme_bw()
```

```{r}
ggplot(data = prm_elasmo %>% 
         filter(estimate_type != "post-release survival")) +
  geom_boxplot(aes(x = habitat_associated, y = estimate)) +
  facet_wrap(~ estimate_type) +
  labs(x = "Habitat associated",
       y = "Proportion of mortality") +
  coord_flip() +
  theme_bw()
```



























