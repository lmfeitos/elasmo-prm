---
title: "random_forest"
author: "Leonardo Feitosa"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache = FALSE
)
library(tidyverse)
library(tidymodels)
library(here)
library(randomForest)
library(ranger)
library(googlesheets4)
library(naniar)
library(ggpmisc)
library(vip)

set.seed(42)
```

```{r}
prm_elasmo <- read_csv(here("data", "prm_hypoxia.csv")) %>%
  filter(gear_class == "longline") %>%
  filter(!grepl("Rajidae", family)) %>%
  filter(family != "Dasyatidae") %>%
  filter(family != "Pristidae") %>%
  filter(family != "Rhinidae") %>%
  filter(family != "Rhinobatidae") %>%
  mutate(habitat = case_when(
    habitat_associated == "pelagic" ~ "pelagic",
    habitat_associated == "reef-associated" ~ "pelagic",
    habitat_associated == "bathypelagic" ~ "pelagic",
    habitat_associated == "benthopelagic" ~ "pelagic",
    habitat_associated == "demersal" ~ "demersal",
    habitat_associated == "bathydemersal" ~ "demersal",
  )) %>%
  mutate(ventilation_method = case_when(
    scientific_name == "Ginglymostoma cirratum" ~ "stationary",
    TRUE ~ ventilation_method
  )) %>%
  mutate(reproductive_mode = case_when(
    scientific_name == "Hexanchus nakamurai" ~ "yolk-sac viviparity",
    TRUE ~ reproductive_mode
  )) %>%
  mutate(reproductive_mode = ifelse(reproductive_mode == "oophagy", "yolk-sac viviparity", reproductive_mode)) %>%  
  group_by(scientific_name) %>%
  mutate(median_depth = mean(median_depth)) %>%
  distinct()
```

```{r}
# create data subset with variables that will be used in the random forest model
prm_elasmo_subset <- prm_elasmo %>%
  select(
    scientific_name, gear_class, habitat, estimate_type, estimate, sample_size,
    method, ventilation_method, max_size_cm, ac, measure, median_depth, evol_dist, reproductive_mode, family, eo
  ) %>%
  mutate(measure = case_when(
    scientific_name == "sharks" ~ "total_length",
    scientific_name %in% c("rays", "Dasyatis sp") ~ "disk_width",
    TRUE ~ measure
  )) %>%
  mutate(reproductive_mode = case_when(
    scientific_name == "sharks" ~ "yolk-sac viviparity",
    scientific_name == "rays" ~ "yolk-sac viviparity",
    TRUE ~ reproductive_mode
  )) %>%
  mutate_if(is.character, as.factor) %>%
  filter(!grepl("sp", scientific_name))

# Create subset of the whole dataset with at-vessel mortality and calculate the weighted averages per species and gear
elasmo_avm <- prm_elasmo_subset %>%
  filter(estimate_type == "at-vessel mortality") %>%
  filter(sample_size > 5) %>%
  group_by(scientific_name, gear_class) %>%
  mutate(mortality_prop = weighted.mean(estimate, sample_size)) %>%
  select(ventilation_method, median_depth, max_size_cm, habitat, reproductive_mode, evol_dist, ac, mortality_prop, family) %>%
  distinct() %>%
  drop_na()

# Create subset of the whole dataset with post-release mortality and calculate the weighted averages per species and gear
elasmo_prm <- prm_elasmo_subset %>%
  filter(estimate_type == "post-release mortality") %>%
  filter(sample_size > 5) %>%
  group_by(scientific_name, gear_class) %>%
  mutate(mortality_prop = weighted.mean(estimate, sample_size)) %>%
  select(ventilation_method, median_depth, max_size_cm, habitat, reproductive_mode, evol_dist, mortality_prop, family, ac) %>%
  distinct() %>%
  drop_na()
```

```{r}
# split the data into training and test set
## At-vessel mortality
avm_split <- initial_split(elasmo_avm, prop = .7, strata = family)

avm_train <- training(avm_split)
avm_test <- testing(avm_split)

avm_folds <- vfold_cv(avm_train, repeats = 5, v = 10, strata = family)

## Post-release mortality
# prm_split <- initial_split(elasmo_prm, prop = .7)
#
# prm_train <- training(prm_split)
# prm_test <- testing(prm_split)

prm_folds <- vfold_cv(elasmo_prm, repeats = 5, v = 10, strata = family)
```


## Overview

This model aims to predict the likelihood of mortality per taxonomic family between sharks and rays using several species-specific bioecological features such as ventilation mode, median temperature, reproductive mode, median depth, as well as technological features such as the fishing gear each species was captured with.

```{r}
# Create the recipes for each estimate
 avm_recipe <- recipe(mortality_prop ~ median_depth + max_size_cm + reproductive_mode + evol_dist + ac, data = avm_train) %>%
   step_normalize(all_numeric_predictors())

prm_recipe <- recipe(mortality_prop ~ median_depth + max_size_cm + reproductive_mode + evol_dist + ac, data = elasmo_prm) %>%
  step_normalize(all_numeric_predictors())
```

```{r}
# create models
 avm_rf <- rand_forest(trees = tune(), mtry = tune(), min_n = tune(), mode = "regression") %>%
   set_engine("ranger", verbose = TRUE, oob.error = TRUE, quantreg = TRUE, splitrule = "beta", importance = "impurity")

prm_rf <- rand_forest(trees = tune(), mtry = tune(), min_n = tune(), mode = "regression") %>%
  set_engine("ranger", verbose = TRUE, oob.error = TRUE, quantreg = TRUE, splitrule = "beta", importance = "impurity")
```

```{r}
# create workflows
 avm_wflw <- workflow() %>%
   add_model(avm_rf) %>%
   add_recipe(avm_recipe)

prm_wflw <- workflow() %>%
  add_model(prm_rf) %>%
  add_recipe(prm_recipe)
```

### Cross Validation

Cross validation will be used to choose the best hyperparameters for use in the model: 

* Number of trees
* Number of predictors in each sample
* Minimum data points in each node required for node split

```{r,include=FALSE}
  avm_tune <- avm_wflw %>% # use cross validation to tune parameters
    tune_grid(
      resamples = avm_folds, # add cv folds
      grid = 10 # grid_regular(trees(), finalize(mtry(), avm_train), min_n(), levels = 10) %>% filter(mtry < 7)
    ) # use grid of parameters to test
```

```{r,include=FALSE}
 prm_tune <- prm_wflw %>% # use cross validation to tune parameters
   tune_grid(
     resamples = prm_folds, # add cv folds
     grid = 10# grid_regular(trees(), finalize(mtry(), elasmo_prm), min_n(), levels = 10) %>% filter(mtry < 7)
   ) # use grid of parameters to test
```

Below displays the results of cross validation tuning

```{r}
# autoplot(avm_tune) + # plot results of tuning
#   theme_bw() # change theme
```

```{r}
select_best(avm_tune, metric = "rsq", n = 1) # get the best model
```

```{r, include=FALSE}
avm_final <- finalize_workflow(avm_wflw, select_best(avm_tune, metric = "rsq")) # finalize the workflow with the best model
#
#saveRDS(avm_final, here::here("data", "avm_final_test.rds"))

 #avm_final <- readRDS(here::here("data", "avm_final_test.rds"))
```

```{r, include=FALSE}
avm_fit <- fit(avm_final, avm_train) # fit the data to the training data
```

```{r, include=FALSE}
avm_train_predict <- predict(object = avm_fit, new_data = avm_train) %>% # predict the training set
  bind_cols(avm_train) # bind training set column to prediction

avm_test_predict <- predict(object = avm_fit, new_data = avm_test) %>% # predict the training set
 bind_cols(avm_test) # bind prediction to testing data column
```

```{r}
avm_train_metrics <- avm_train_predict %>%
  metrics(mortality_prop, .pred) # get testing data metrics
avm_train_metrics

avm_test_metrics <- avm_test_predict %>%
  metrics(mortality_prop, .pred) # get testing data metrics
avm_test_metrics
```

Below displays the results of cross validation tuning

```{r}
# autoplot(prm_tune) + # plot results of tuning
#   theme_bw() # change theme
```

```{r}
select_best(prm_tune, metric = "rsq", n = 1) # get the best model
```

```{r, include=FALSE}
prm_final <- finalize_workflow(prm_wflw, select_best(prm_tune, metric = "rsq")) # finalize the workflow with the best model
#
#saveRDS(prm_final, here::here("data", "prm_final_ac_test.rds"))

 #prm_final <- readRDS(here::here("data", "prm_final_ac_test.rds"))
```

```{r, include=FALSE}
prm_fit <- fit(prm_final, elasmo_prm) # fit the data to the training data
```

```{r, include=FALSE}
prm_train_predict <- predict(object = prm_fit, new_data = elasmo_prm) %>% # predict the training set
  bind_cols(elasmo_prm) # bind training set column to prediction

# prm_test_predict <- predict(object = prm_fit, new_data = prm_test) %>% # predict the training set
#   bind_cols(prm_test)# bind prediction to testing data column
```

```{r}
prm_train_metrics <- prm_train_predict %>%
  metrics(mortality_prop, .pred) # get testing data metrics
prm_train_metrics

# prm_test_metrics <- prm_test_predict %>%
#   metrics(mortality_prop, .pred) # get testing data metrics
# prm_test_metrics
```

```{r}
my_controls <- control_resamples(
  verbose = TRUE,
  save_pred = TRUE,
  extract = function(x) {
    model <- extract_fit_engine(x)
    model$prediction.error
  }
) # set to get prediction and out of bag errors

avm_cv2 <- avm_final %>%
 fit_resamples(avm_folds, control = my_controls) # fit the folds to the final model

prm_cv2 <- prm_final %>%
  fit_resamples(prm_folds, control = my_controls) # fit the folds to the final model
```

```{r}
collect_metrics(avm_cv2)

collect_metrics(prm_cv2)
```

### Variable importance for the at-vessel mortality and post-release mortality RF models

```{r}
 avm_fit %>%
   extract_fit_parsnip() %>%
   vip()

prm_fit %>%
  extract_fit_parsnip() %>%
  vip()
```



## Quantile regression

For AVM

```{r}
preds_bind <- function(data_fit, rf_fit) {
  predict(
    rf_fit$fit$fit$fit,
    workflows::extract_recipe(rf_fit) %>% bake(data_fit),
    type = "quantiles",
    quantiles = c(.05, .25, .5, .75, .95)
  ) %>%
    with(predictions) %>%
    as_tibble() %>%
    set_names(paste0(".pred", c("_05", "_25", "_50", "_75", "_95"))) %>%
    bind_cols(data_fit)
} # function to preform and extract quantile estimates from random forest

avm_data <- full_join(avm_test_predict, avm_train_predict)

# predict quantiles
avm_quant_test <- preds_bind(avm_data, avm_fit) %>%
  mutate(
    range_50 = .pred_75 - .pred_25,
    range_95 = .pred_95 - .pred_05
  )

q1 <- ggplot(avm_quant_test) +
  geom_boxplot(aes(range_50)) +
  theme_bw(base_size = 14) +
  labs(x = "Distribution of IQR for AVM") +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
q1

write_csv(avm_quant_test, here::here("data", "avm_model_predictions_test.csv"))
```

For PRM

```{r}
# predict quantiles
prm_quant_test <- preds_bind(prm_train_predict, prm_fit) %>%
  mutate(
    range_50 = .pred_75 - .pred_25,
    range_95 = .pred_95 - .pred_05
  )

q2 <- ggplot(prm_quant_test) +
  geom_boxplot(aes(range_50)) +
  theme_bw(base_size = 14) +
  labs(x = "Distribution of IQR for PRM") +
  theme(
    axis.title.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank()
  )
q2

write_csv(prm_quant_test, here::here("data", "prm_model_predictions_test.csv"))
```

## AVM model - real values vs predicted values 

```{r}
p1 <- ggplot(avm_quant_test, aes(x = mortality_prop, y = .pred_50)) + # plot ln of real versus ln of predicted
  geom_point() +
  stat_poly_line() +
  stat_poly_eq(use_label("eq")) +
  stat_poly_eq(label.y = 0.9) +
  theme_bw(base_size = 14) +
  labs(
    x = "Observed AVM Rate",
    y = "Predicted AVM Rate"
  )
p1

summary(lm(.pred_50 ~ mortality_prop, data = avm_quant_test))
```

## PRM model - real values vs predicted values

```{r}
p2 <- ggplot(prm_train_predict, aes(x = mortality_prop, y = .pred)) + # plot ln of real versus ln of predicted
  geom_point() +
  stat_poly_line() +
  stat_poly_eq(use_label("eq")) +
  stat_poly_eq(label.y = 0.9) +
  theme_bw(base_size = 14) +
  labs(
    x = "Observed PRM Rate",
    y = "Predicted PRM Rate"
  )
p2

summary(lm(.pred ~ mortality_prop, data = prm_train_predict))
```

### Variable importance for the at-vessel mortality and post-release mortality RF models

```{r}
v1 <- avm_fit %>%
  extract_fit_parsnip() %>%
  vip() +
  theme_bw(base_size = 14) +
  labs(y = "Variable Importance for At-Vessel Mortality") +
  scale_x_discrete(labels = c("Reproductive Mode", "Median Depth (m)", "Maximum Size (cm)", "Evolutionary distance", "Hypoxia Vulnerability"))
v1

v2 <- prm_fit %>%
  extract_fit_parsnip() %>%
  vip() +
  theme_bw(base_size = 14) +
  labs(y = "Variable Importance for Post-Release Mortality") +
  scale_x_discrete(labels = c("Reproductive Mode", "Median Depth (m)", "Maximum Size (cm)", "Evolutionary distance", "Hypoxia Vulnerability"))
v2
```

### Predict additional shark species

```{r}
# filter out rays and missing values
new_dat <- read_csv(here::here("data", "predict_data_phylo.csv")) %>%
  mutate(reproductive_mode = ifelse(reproductive_mode == "oophagy", "yolk-sac viviparity", reproductive_mode)) %>% 
  filter(order != "Rajiformes") %>%
  filter(order != "Myliobatiformes") %>%
  filter(order != "Torpediniformes") %>%
  # filter(!grepl("batidae", family)) %>%
  filter(family != "Dasyatidae") %>%
  # filter(family != "Glaucostegidae") %>% # I'd remove this filter
  # filter(family != "Pristidae") %>% # I'd remove this filter
  filter(family != "Trygonorrhinidae") %>%
  filter(!is.na(median_depth)) %>%
  filter(!is.na(ac)) %>%
  filter(!is.na(evol_dist)) %>%
  filter(!is.na(ventilation_method)) %>%
  filter(!is.na(reproductive_mode)) %>%
  filter(!is.na(habitat_associated)) %>%
  filter(!is.na(max_size_cm)) %>%
  mutate(ventilation_method = as.factor(ventilation_method)) %>%
  mutate(habitat_associated = as.factor(habitat_associated)) %>%
  mutate(reproductive_mode = as.factor(reproductive_mode)) %>%
  filter(reproductive_mode != "histotrophy") %>%
  mutate(habitat = case_when(
    habitat_associated == "pelagic" ~ "pelagic",
    habitat_associated == "reef-associated" ~ "pelagic",
    habitat_associated == "bathypelagic" ~ "pelagic",
    habitat_associated == "benthopelagic" ~ "pelagic",
    habitat_associated == "demersal" ~ "demersal",
    habitat_associated == "bathydemersal" ~ "demersal",
  ))

# predict AVM
predict_data <- list(avm_train, avm_test, new_dat) %>%
  reduce(full_join) %>%
  rename(avm_mort = mortality_prop) %>%
  full_join(elasmo_prm) %>%
  rename(prm_mort = mortality_prop) %>%
  distinct() %>%
  mutate(habitat = as.factor(habitat)) %>%
  filter(!is.na(ac)) 

predict_avm <- predict(object = avm_fit, new_data = predict_data) %>% # predict the training set
  bind_cols(predict_data) %>% # bind training set column to prediction
  rename(avm_pred = .pred)

# predict PRM
predict_avm_prm <- predict(object = prm_fit, new_data = predict_avm) %>% # predict the training set
  bind_cols(predict_avm) %>% # bind training set column to prediction
  rename(prm_pred = .pred)

# combine predictions
full_prediction_avm <- preds_bind(predict_avm_prm, avm_fit) %>%
  rename(
    avm_75 = .pred_75,
    avm_95 = .pred_95,
    avm_05 = .pred_05,
    avm_25 = .pred_25,
    avm_50 = .pred_50
  )

full_predictions <- preds_bind(full_prediction_avm, prm_fit) %>%
  rename(
    prm_75 = .pred_75,
    prm_95 = .pred_95,
    prm_05 = .pred_05,
    prm_25 = .pred_25,
    prm_50 = .pred_50
  ) %>% 
  select(
    order, species, genus, prm_05, prm_25, prm_50, prm_75,
    prm_95, avm_05, avm_25, avm_50,
    avm_75, avm_95, prm_pred, avm_pred,
    scientific_name, gear_class, ventilation_method, median_depth,
    max_size_cm, habitat, reproductive_mode, evol_dist,
    ac, avm_mort, family, family, prm_mort
  )

write_csv(full_predictions, here::here("data", "full_model_predictions_test.csv"))
```
 
## Figures for paper

```{r}
#plot1 <- (p1 + v1 + q1) / (p2 + v2 + q2) + plot_annotation(tag_levels = "A")

#ggsave(plot1, file = paste0("fig2_test.pdf"), path = here::here("figs"), height = 12, width = 18)
```

```{r}
library(janitor)
library(ggridges)
# read in the IUCN data
iucn_data <- read_csv(here::here("data", "iucn_data", "assessments.csv")) %>%
  janitor::clean_names() %>%
  filter(str_detect(systems, "Marine") & str_detect(threats, "longline") |
    str_detect(scientific_name, "Squatina|Isogomphodon|Carcharhinus|Eusphyra|Orectolobus|Pristiophorus|Mustelus|Stegostoma")) %>% # list of genera to keep in the filtering
  select(scientific_name, redlist_category, year_published) %>%
  mutate(redlist_category = case_when(
    str_detect(redlist_category, "Near") ~ "NT",
    str_detect(redlist_category, "Vul") ~ "VU",
    str_detect(redlist_category, "Data") ~ "DD",
    redlist_category == "Endangered" ~ "EN",
    redlist_category == "Critically Endangered" ~ "CR",
    str_detect(redlist_category, "Least") ~ "LC",
    TRUE ~ redlist_category
  ))

#read in taxonomic assigmnets of IUCN data
iucn_taxonomy <- read_csv(here("data", "iucn_data", "taxonomy.csv")) %>%
  clean_names() %>%
  mutate(family = str_to_sentence(family_name)) %>%
  select(family, genus_name, species_name) %>%
  unite(col = "scientific_name", c(genus_name, species_name), sep = " ")


# read in the AVM PRM model predictions
full_predictions <- read_csv(here::here("data", "full_model_predictions_test.csv")) %>%
  filter(scientific_name %in% iucn_data$scientific_name) %>% 
  filter(!family %in% c("Megachasmidae", "Stegostomatidae"))

```


# get the mean of predictions for each species
```{r}
mean_predictions <- full_predictions %>%
  group_by(scientific_name) %>%
  mutate(
    avm_pred = mean(avm_pred),
    prm_pred = mean(prm_pred)
  )
```


```{r}
#pivot estimates to a single column
predictions <- mean_predictions %>%
  pivot_longer(cols = c("avm_pred", "prm_pred"), names_to = "estimate_type", values_to = "mortality_prop") %>%
  mutate(estimate_type = case_when(
    estimate_type == "avm_pred" ~ "AVM",
    estimate_type == "prm_pred" ~ "PRM"
  ))

```


```{r}
#get family level estimates for AVM
mort_subset_avm <- mean_predictions %>%
  group_by(family) %>%
  summarize(fam_mean = mean(avm_pred)) %>%
  arrange(fam_mean) %>%
  distinct(family) %>%
  pull(family)
```


```{r}
#get family level estimates for PRM
mort_subset_prm <- mean_predictions %>%
  group_by(family) %>%
  summarize(fam_mean = mean(prm_pred)) %>%
  arrange(desc(fam_mean)) %>%
  distinct(family) %>%
  pull(family)
```

```{r, fig.width= 20, fig.height = 22}
p6 <- ggplot() +
  geom_density_ridges(data = predictions, aes(x = mortality_prop, y = fct_rev(factor(family, levels = mort_subset_avm)), fill = fct_rev(factor(family, levels = mort_subset_avm))), alpha = 0.5) +
  geom_point(data = predictions, aes(x = mortality_prop, y = fct_rev(factor(family, levels = mort_subset_avm)), color = fct_rev(factor(family, levels = mort_subset_avm))), alpha = 0.5, size = 6) +
  scale_fill_viridis_d() +
  scale_color_viridis_d() +
  facet_grid(
    cols = vars(estimate_type),
    scales = "free_x",
    space = "free_x"
  ) +
  labs(
    y = "Family",
    x = "Estimated Mortality"
  ) +
  scale_shape(guide = "none") +
  theme_bw(base_size = 14) +
  theme(
    axis.text = element_text(color = "black"),
    # axis.text.y = element_text(face = "italic"),
    axis.title = element_text(color = "black"),
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_blank(),
    strip.background = element_rect(fill = "transparent"),
    panel.spacing.x = unit(5, "mm"),
    legend.position = "none"
  )

p6

ggsave(p6, file = paste0("fig3_test.pdf"), path = here::here("figs"), height = 12, width = 18)
```

