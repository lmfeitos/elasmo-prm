---
title: "random_forest"
author: "Leonardo Feitosa"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache = FALSE
)
library(tidyverse)
library(tidymodels)
library(here)
library(randomForest)
library(ranger)
library(googlesheets4)
library(naniar)
library(vip)
library(patchwork)
library(ggpmisc)

# Set data paths
basedir <- "G:/Meu Drive/PRM review/"
datadir <- file.path(basedir, "data/fish_base_data")
outdir <- file.path(basedir, "data/outputs") # calls present data from raster files

set.seed(42)
```

```{r}
prm_elasmo <- read_csv(here("data", "prm_elasmo_subset.csv")) %>%
  filter(gear_class == "longline") %>% 
  filter(!grepl("Rajidae", family))
```

```{r}
# create data subset with variables that will be used in the random forest model
prm_elasmo_subset <- prm_elasmo %>%
  select(
    scientific_name, gear_class, habitat_associated, estimate_type, estimate, sample_size,
    method, ventilation_method, max_size_cm, measure, median_depth, reproductive_mode, family
  ) %>%
  mutate(measure = case_when(
    scientific_name == "sharks" ~ "total_length",
    scientific_name %in% c("rays", "Dasyatis sp") ~ "disk_width",
    TRUE ~ measure
  )) %>%
  mutate(reproductive_mode = case_when(
    scientific_name == "sharks" ~ "yolk-sac viviparity",
    scientific_name == "rays" ~ "yolk-sac viviparity",
    TRUE ~ reproductive_mode
  )) %>%
  mutate_if(is.character, as.factor) %>% 
  filter(!grepl("sp", scientific_name))

# Create subset of the whole dataset with at-vessel mortality and calculate the weighted averages per species and gear
elasmo_avm <- prm_elasmo_subset %>%
  filter(estimate_type == "at-vessel mortality" & estimate > 0) %>%
  mutate(est_count = sample_size * estimate) %>%
  group_by(scientific_name, gear_class) %>%
  mutate(mortality_prop = sum(est_count) / sum(sample_size)) %>%
  drop_na()

# Create subset of the whole dataset with post-release mortality and calculate the weighted averages per species and gear
elasmo_prm <- prm_elasmo_subset %>%
  filter(estimate_type == "post-release mortality" & estimate > 0) %>%
  mutate(est_count = sample_size * estimate) %>%
  group_by(scientific_name, gear_class) %>%
  mutate(mortality_prop = sum(est_count) / sum(sample_size)) %>%
  drop_na()
```

```{r}
# split the data into training and test set
## At-vessel mortality
avm_split <- initial_split(elasmo_avm, prop = .7)

avm_train <- training(avm_split)
avm_test <- testing(avm_split)

avm_folds <- vfold_cv(elasmo_avm, repeats = 5, v = 10)

## Post-release mortality
# prm_split <- initial_split(elasmo_prm, prop = .7)
#
# prm_train <- training(prm_split)
# prm_test <- testing(prm_split)

prm_folds <- vfold_cv(elasmo_prm, repeats = 5, v = 10)
```


## Overview

This model aims to predict the likelihood of mortality per taxonomic family between sharks and rays using several species-specific bioecological features such as ventilation mode, median temperature, reproductive mode, median depth, as well as technological features such as the fishing gear each species was captured with.

```{r}
# Create the recipes for each estimate
avm_recipe <- recipe(mortality_prop ~ ventilation_method + median_depth + max_size_cm + reproductive_mode, data = avm_train) %>%
  step_normalize(all_numeric_predictors())

prm_recipe <- recipe(mortality_prop ~ reproductive_mode + median_depth + max_size_cm + habitat_associated, data = elasmo_prm) %>%
  step_normalize(all_numeric_predictors())
```

```{r}
# create models
avm_rf <- rand_forest(trees = tune(), mtry = tune(), min_n = tune(), mode = "regression") %>%
  set_engine("ranger", verbose = TRUE, oob.error = TRUE, quantreg = TRUE, splitrule = "beta", importance = "impurity")

prm_rf <- rand_forest(trees = tune(), mtry = tune(), min_n = tune(), mode = "regression") %>%
  set_engine("ranger", verbose = TRUE, oob.error = TRUE, quantreg = TRUE, splitrule = "beta", importance = "impurity")
```

```{r}
# create workflows
avm_wflw <- workflow() %>%
  add_model(avm_rf) %>%
  add_recipe(avm_recipe)

prm_wflw <- workflow() %>%
  add_model(prm_rf) %>%
  add_recipe(prm_recipe)
```

### Cross Validation

Cross validation will be used to choose the best hyperparameters for use in the model: 

* Number of trees
* Number of predictors in each sample
* Minimum data points in each node required for node split

```{r,include=FALSE}
# avm_tune <- avm_wflw %>% # use cross validation to tune parameters
#   tune_grid(
#     resamples = avm_folds, # add cv folds
#     grid = 10
#   ) # use grid of parameters to test
```

```{r,include=FALSE}
# prm_tune <- prm_wflw %>% # use cross validation to tune parameters
#   tune_grid(
#     resamples = prm_folds, # add cv folds
#     grid = 10
#   ) # use grid of parameters to test
```

Below displays the results of cross validation tuning

```{r}
# autoplot(avm_tune) + # plot results of tuning
#   theme_bw() # change theme
```

```{r}
# select_best(avm_tune, metric = "rsq", n = 1) # get the best model
```

```{r, include=FALSE}
# avm_final <- finalize_workflow(avm_wflw, select_best(avm_tune, metric = "rsq")) # finalize the workflow with the best model
# 
# saveRDS(avm_final, here::here("data", "avm_final.rds"))

avm_final <- readRDS(here::here("data", "avm_final.rds"))
```

```{r, include=FALSE}
avm_fit <- fit(avm_final, avm_train) # fit the data to the training data
```

```{r, include=FALSE}
avm_train_predict <- predict(object = avm_fit, new_data = avm_train) %>% # predict the training set
  bind_cols(avm_train) # bind training set column to prediction

avm_test_predict <- predict(object = avm_fit, new_data = avm_test) %>% # predict the training set
  bind_cols(avm_test) # bind prediction to testing data column
```

```{r}
avm_train_metrics <- avm_train_predict %>%
  metrics(mortality_prop, .pred) # get testing data metrics
avm_train_metrics

avm_test_metrics <- avm_test_predict %>%
  metrics(mortality_prop, .pred) # get testing data metrics
avm_test_metrics
```

Below displays the results of cross validation tuning

```{r}
# autoplot(prm_tune) + # plot results of tuning
#   theme_bw() # change theme
```

```{r}
# select_best(prm_tune, metric = "rsq", n = 1) # get the best model
```

```{r, include=FALSE}
# prm_final <- finalize_workflow(prm_wflw, select_best(prm_tune, metric = "rsq")) # finalize the workflow with the best model
# 
# saveRDS(prm_final, here::here("data", "prm_final.rds"))

prm_final <- readRDS(here::here("data", "prm_final.rds"))
```

```{r, include=FALSE}
prm_fit <- fit(prm_final, elasmo_prm) # fit the data to the training data
```

```{r, include=FALSE}
prm_train_predict <- predict(object = prm_fit, new_data = elasmo_prm) %>% # predict the training set
  bind_cols(elasmo_prm) # bind training set column to prediction

# prm_test_predict <- predict(object = prm_fit, new_data = prm_test) %>% # predict the training set
#   bind_cols(prm_test)# bind prediction to testing data column
```

```{r}
prm_train_metrics <- prm_train_predict %>%
  metrics(mortality_prop, .pred) # get testing data metrics
prm_train_metrics

# prm_test_metrics <- prm_test_predict %>%
#   metrics(mortality_prop, .pred) # get testing data metrics
# prm_test_metrics
```

```{r}
my_controls <- control_resamples(
  verbose = TRUE,
  save_pred = TRUE,
  extract = function(x) {
    model <- extract_fit_engine(x)
    model$prediction.error
  }
) # set to get prediction and out of bag errors

avm_cv2 <- avm_final %>%
  fit_resamples(avm_folds, control = my_controls) # fit the folds to the final model

prm_cv2 <- prm_final %>%
  fit_resamples(prm_folds, control = my_controls) # fit the folds to the final model
```

```{r}
collect_metrics(avm_cv2)

collect_metrics(prm_cv2)
```

## Quantile regression

```{r}
preds_bind <- function(data_fit, rf_fit) {
  predict(
    rf_fit$fit$fit$fit,
    workflows::extract_recipe(rf_fit) %>% bake(data_fit),
    type = "quantiles",
    quantiles = c(.05, .25, .5, .75, .95)
  ) %>%
    with(predictions) %>%
    as_tibble() %>%
    set_names(paste0(".pred", c("_05", "_25", "_50", "_75", "_95"))) %>%
    bind_cols(data_fit)
} # function to preform and extract quantile estimates from random forest

avm_data <- full_join(avm_test_predict, avm_train_predict)

avm_quant_test <- preds_bind(avm_data, avm_fit) %>%
  mutate(
    range_50 = .pred_75 - .pred_25,
    range_95 = .pred_95 - .pred_05
  )

quant_in_50 <- avm_quant_test %>%
  filter(!is.na(mortality_prop)) %>%
  mutate(in_interval = mortality_prop <= .pred_75 & mortality_prop >= .pred_25) %>%
  group_by(in_interval) %>%
  summarize(count = n())

percent_50 <- quant_in_50$count[2] / (quant_in_50$count[1] + quant_in_50$count[2]) * 100
percent_50

ggplot(avm_quant_test) +
  geom_boxplot(aes(range_50)) +
  theme_bw()

write_csv(avm_quant_test, here::here("data", "avm_model_predictions.csv"))
```

```{r}
prm_quant_test <- preds_bind(prm_train_predict, prm_fit) %>%
  mutate(
    range_50 = .pred_75 - .pred_25,
    range_95 = .pred_95 - .pred_05
  )

quant_in_50 <- prm_quant_test %>%
  filter(!is.na(mortality_prop)) %>%
  mutate(in_interval = mortality_prop <= .pred_75 & mortality_prop >= .pred_25) %>%
  group_by(in_interval) %>%
  summarize(count = n())

percent_50 <- quant_in_50$count[2] / (quant_in_50$count[1] + quant_in_50$count[2]) * 100
percent_50

ggplot(prm_quant_test) +
  geom_boxplot(aes(range_50)) +
  theme_bw()

write_csv(prm_quant_test, here::here("data", "prm_model_predictions.csv"))
```


## AVM model - real values vs predicted values 

```{r}
p1 <- ggplot(avm_quant_test, aes(x = mortality_prop, y = .pred_50)) + # plot ln of real versus ln of predicted
  geom_point() +
  stat_poly_line() +
  stat_poly_eq(use_label("eq")) +
  stat_poly_eq(label.y = 0.9) +
  theme_bw() +
  labs(
    x = "Observed At-Vessel Mortality Rate",
    y = "Predicted At-Vessel Mortality Rate"
  ) +
  theme(text = element_text(size = 10))
p1

summary(lm(.pred_50 ~ mortality_prop, data = avm_quant_test))
```

## PRM model - real values vs predicted values

```{r}
p2 <- ggplot(prm_train_predict, aes(x = mortality_prop, y = .pred)) + # plot ln of real versus ln of predicted
  geom_point() +
  stat_poly_line() +
  stat_poly_eq(use_label("eq")) +
  stat_poly_eq(label.y = 0.9) +
  theme_bw() +
  labs(
    x = "Observed Post Release Mortality Rate",
    y = "Predicted Post Release Mortality Rate"
  ) +
  theme(text = element_text(size = 10))
p2

summary(lm(.pred ~ mortality_prop, data = prm_train_predict))
```

### Variable importance for the at-vessel mortality and post-release mortality RF models

```{r}
v1 <- avm_fit %>%
  extract_fit_parsnip() %>%
  vip() +
  theme_bw()
v1

v2 <- prm_fit %>%
  extract_fit_parsnip() %>%
  vip() +
  theme_bw()
v2
```


```{r}
new_dat <- read_csv(here::here("data", "iucn_fishbase_list.csv")) %>% 
  rename(median_depth = median_depth_2) %>% 
  rename(habitat_associated = demers_pelag) %>% 
  rename(max_size_cm = length) %>% 
  filter(order != "Rajiformes") %>%
  filter(!is.na(median_depth)) %>%
  filter(!is.na(ventilation_method)) %>%
  filter(!is.na(reproductive_mode)) %>%
  filter(!is.na(habitat_associated)) %>%
  # filter(habitat_associated != "bathypelagic") %>%
  filter(!is.na(max_size_cm)) %>%
  select(-measure_fb) %>%
  mutate(ventilation_method = as.factor(ventilation_method)) %>%
  mutate(habitat_associated = as.factor(habitat_associated)) %>%
  mutate(reproductive_mode = as.factor(reproductive_mode))

predict_data <- list(avm_train, avm_test, new_dat) %>%
  reduce(full_join) %>%
  rename(avm_mort = mortality_prop) %>%
  select(-estimate_type, -sample_size, -method, -estimate, -est_count) %>%
  full_join(elasmo_prm) %>%
  rename(prm_mort = mortality_prop) %>%
  select(-estimate_type, -sample_size, -method, -estimate, -est_count) %>%
  distinct()

predict_avm <- predict(object = avm_fit, new_data = predict_data) %>% # predict the training set
  bind_cols(predict_data) %>% # bind training set column to prediction
  rename(avm_pred = .pred)

predict_avm_prm <- predict(object = prm_fit, new_data = predict_avm) %>% # predict the training set
  bind_cols(predict_avm) %>% # bind training set column to prediction
  rename(prm_pred = .pred)

full_prediction_avm <- preds_bind(predict_avm_prm, avm_fit) %>%
  rename(
    avm_75 = .pred_75,
    avm_95 = .pred_95,
    avm_05 = .pred_05,
    avm_25 = .pred_25,
    avm_50 = .pred_50
  )

full_predictions <- preds_bind(full_prediction_avm, prm_fit) %>%
  rename(
    prm_75 = .pred_75,
    prm_95 = .pred_95,
    prm_05 = .pred_05,
    prm_25 = .pred_25,
    prm_50 = .pred_50
  )

write_csv(full_predictions, here::here("data", "full_model_predictions.csv"))
```

## Figures

```{r}
full_predictions <- read_csv(here("data", "full_model_predictions.csv"))
```


AVM

```{r}
plot1 <- p1 + v1 + plot_annotation(tag_levels = "A")

ggsave(plot1, file = paste0("avm_val.pdf"), path = here::here("figs"), height = 10, width = 15)
```

PRM

```{r}
plot2 <- p2 + v2 + plot_annotation(tag_levels = "A")

ggsave(plot2, file = paste0("prm_val.pdf"), path = here::here("figs"), height = 10, width = 15)
```

```{r}
mean_predictions =  full_predictions %>% 
  mutate(group = case_when(
    str_detect(family, "Mobulidae|Dasyatiade|Gymnyridae|Myliobatidae|Torpedinidae|Rhinobatidae|Rhinidae|Aetobatidae|Rajidae|Pristidae") ~ "Batoids",
    str_detect(scientific_name, "Himantura|Dasyatis|Gymnura|trygon|Bathytoshia|rays|raja|Rhinoptera|Sympterygia|Pastinachus|Urobatis|Glaucostegus|Hypanus") ~ "Batoids",
    TRUE ~ "Sharks"
  )) %>% 
  group_by(scientific_name) %>% 
  summarize(avm_pred = mean(avm_pred),
            prm_pred = mean(prm_pred),
            group = group) %>% 
  mutate(group = fct_relevel(group, c("Sharks", "Batoids")))

predictions = mean_predictions %>% 
  pivot_longer(cols = c("avm_pred", "prm_pred"), names_to = "estimate_type", values_to = "mortality_prop")

mort_subset <- mean_predictions %>% 
  arrange(avm_pred) %>% 
  select(scientific_name, avm_pred) %>% 
  distinct(scientific_name) %>% 
  pull(scientific_name) 
```


```{r}
predictions_fig = ggplot(data = predictions) +
  geom_line(aes(x = fct_rev(factor(scientific_name, levels = mort_subset)), 
                 y = mortality_prop,
                 group = scientific_name),
            show.legend = F,
             color = "gray30",
             linewidth = 0.6,
             alpha = 0.5) +
  coord_flip() +
  theme_bw() +
  geom_point(aes(x = fct_rev(factor(scientific_name, levels = mort_subset)), 
                 y = mortality_prop,
                 color = estimate_type),
             size = 1.5,
             alpha = 0.9,
             show.legend = F) +
  scale_y_continuous(breaks = seq(0, 0.8, 0.2),
                     limits = c(0.05, 0.8),
                     expand = c(0.01, 0.01)) +
  scale_color_manual(values = c("#414487FF", "#22A884FF")) +
  labs(x = "",
       y = "Mean estimated mortality proportion",
       color = "Estimate type") +
  scale_shape(guide = 'none') +
  theme(axis.text = element_text(size = 8, color = "black"),
        axis.text.y = element_text(face = "italic"),
        axis.title = element_text(size = 11, color = "black"),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        strip.background = element_rect(fill = "transparent"),
        panel.spacing.x = unit(5, "mm")) +
  facet_grid(rows = vars(factor(group, levels = c("Sharks", "Batoids"))), 
             scales = "free_y", 
             space = "free_y")
predictions_fig

ggsave(predictions_fig, file = paste0("predictions_fig.pdf"), path = here::here("figs"), height = 20, width = 8)
```
