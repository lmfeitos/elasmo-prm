---
title: "Untitled"
author: "Leonardo Feitosa"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(vegan)

# Set data paths
basedir <- "G:/Meu Drive/PRM review/"
datadir <- file.path(basedir, "data/fish_base_data")
outdir <- file.path(basedir, "data/outputs") # calls present data from raster files
```

## NMDS 
```{r}
sample_cat <- med_sample_species %>% 
  select(species, sex, sample)

sp_num <- med_sample_species %>% 
  select(starts_with("med_")) %>% 
  sqrt()

# Calculating distances
sp_dist <- vegdist(sp_num, method = "euclid")
sp_dist_mat <- as.matrix(sp_dist, labels = T)

sp_mds <- metaMDS(sp_dist_mat, k = 2, trymax = 1000, distance = "euclid", trace = T)

stressplot(sp_mds)

# Assembling NMDS results
data_scores_sp <- as.data.frame(scores(sp_mds))
data_scores_sp$species <- as.factor(sample_cat$species)
data_scores_sp$sex <- as.factor(sample_cat$sex)
species.scores <- as.data.frame(scores(sp_mds,"sites"))
species.scores$cont <- (rownames(species.scores)) 

fit <- envfit(sp_mds, sp_num, perm = 1000)
elements <- c("Mg24", "Ba138", "Mn55", "Sr86")
fit.df <- as.data.frame(scores(fit, display = "vectors"))
fit.df$elements <- (rownames(elements))

```

```{r}
veganCovEllipse <- function(cov, center = c(0, 0), scale = 1, npoints = 100) {
  
  theta <- (0:npoints) * 2 * pi/npoints
  Circle <- cbind(cos(theta), sin(theta))
  t(center + scale * t(Circle %*% chol(cov)))
}
 
#data for species ellipses, in this case using the management factor
df_ell_full <- data.frame() #sets up a data frame before running the function.

for(i in levels(data_scores_sp$species)){
  df_ell_full <- rbind(df_ell_full, 
                      cbind(as.data.frame(with(data_scores_sp[data_scores_sp$species == i,],
                                              veganCovEllipse(cov.wt(cbind(NMDS1, NMDS2),
                                                                     wt = rep(1/length(NMDS1),
                                                                              length(NMDS1)))$cov,
                                                              center = c(mean(NMDS1), mean(NMDS2))))),
                            species = i))
}

 
# data for labelling the ellipse
nmds_mean_full = aggregate(data_scores_sp[ , c("NMDS1", "NMDS2")], 
                         list(group = data_scores_sp$species), "mean")
 
# data for labelling the ellipse
NMDS_mean = aggregate(data_scores_sp[, c("NMDS1", "NMDS2")], 
                    list(group = data_scores_sp$species), "mean")

#data for sex ellipses, in this case using the management factor
df_ell_full_sex <- data.frame() #sets up a data frame before running the function.

for(i in levels(data_scores_sp$sex)){
  df_ell_full_sex <- rbind(df_ell_full_sex, 
                      cbind(as.data.frame(with(data_scores_sp[data_scores_sp$sex == i,],
                                              veganCovEllipse(cov.wt(cbind(NMDS1, NMDS2),
                                                                     wt = rep(1/length(NMDS1),
                                                                              length(NMDS1)))$cov,
                                                              center = c(mean(NMDS1), mean(NMDS2))))),
                            sex = i))
}


 
# data for labelling the ellipse
nmds_mean_full_sex = aggregate(data_scores_sp[ , c("NMDS1", "NMDS2")], 
                         list(group = data_scores_sp$sex), "mean")
 
# data for labelling the ellipse
NMDS_mean_sex = aggregate(data_scores_sp[, c("NMDS1", "NMDS2")], 
                    list(group = data_scores_sp$sex), "mean")


df_ell_bind <- df_ell_full %>% 
  left_join(df_ell_full_sex, by = c("NMDS1", "NMDS2"))
```


## Plot NMDS 2
```{r, fig.width=10, fig.height=8}
ggplot() +   
  geom_point(data = data_scores_sp %>% 
               mutate(sex = str_to_sentence(sex)),
             aes(x = NMDS1, y = NMDS2,
                 shape = sex,
                 color = species),
             size = 3,
             show.legend = T,
             alpha = 1) +
  geom_path(data = df_ell_bind,
            aes(x = NMDS1, y = NMDS2, color = species),
            show.legend = F,
            size = .7) +
  geom_segment(data = fit.df, 
               aes(x = -0, xend = NMDS1*10,
                   y = 0, yend = NMDS2*10),
               arrow = arrow(length = unit(0.25, "cm")),
               linewidth = .8,
               alpha = 0.3) +
  geom_label_repel(data = fit.df,
                   aes(x = NMDS1*10,
                       y = NMDS2*10,
                       label = elements),
                   position = position_nudge_center(x = .2, y = .01,
                                                    center_x = 0, center_y = 0),
                   fontface = "bold",
                   alpha = 0.5) +
  scale_fill_manual(values = met.brewer("Kandinsky", 6)) +
  scale_color_manual(values = met.brewer("Kandinsky", 6)) +
  labs(fill = "",
       shape = "",
       color = "") +
  coord_equal() + 
  theme_bw() +
  theme(legend.key.size = unit(0.6, "cm"),
        legend.background = element_rect(fill = "transparent"),
        legend.text = element_text(size = 12, face = "italic"),
        legend.title = element_text(size = 15),
        legend.position = "bottom",
        axis.title = element_text(size = 13, face = "bold", color = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.grid = element_blank()) +
  guides(shape = "none")


 ggsave(here("outputs", "NMDS_full_2.png"), 
        width = 10, height = 8, bg = "white", dpi = 300)
```
